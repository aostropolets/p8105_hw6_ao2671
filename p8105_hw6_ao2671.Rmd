---
title: "Homework 6"
author: "Anna Ostropolets"
date: "12/1/2020"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(modelr)
knitr::opts_chunk$set(echo = TRUE)
```


# Problem 1

```{r data, warning=FALSE, message=FALSE}
# loading the data
url <- getURL("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
data <- read.csv(text = url)

aggregated_data<-
  data %>%
  mutate(
    city_state = str_c(city, state, sep = ","),
    # recode
    status = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest" ~ 0,
      disposition == "Closed by arrest" ~ 1,
    ),
    victim_age = as.numeric(na_if(victim_age,'Unknown'))
  ) %>%
  filter(!city_state %in% c("Tulsa,AL", "Dallas,TX", "Phoenix,AZ",  "Kansas City,MO")
         & victim_race %in% c("White","Black"))
```

Odds ratios of solving homicides comparing white victims to non-white victims in Baltimore

```{r glm_baltimore}
baltimore = 
  aggregated_data %>% 
  filter(city_state == "Baltimore,MD") %>%
  as.matrix()

glm(status ~ victim_age + victim_race + victim_sex,
    data = aggregated_data,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  filter(term == "victim_raceWhite") %>%
  select(OR, starts_with("CI")) 
```


Running the same linear regression for all cities

```{r glm}
glm <-
  aggregated_data %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(status ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
    ) %>%
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  filter(term == "victim_raceWhite") %>%
  select(city_state, OR, starts_with("CI"))
```

A plot showing odds ratios of solving crimes for white vs non-white victims across states.


```{r plot}
  glm %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(title = "Odds ratios of solving crimes for non-white vs white victims across states")
```


# Problem 2

Import data for problem 2

```{r data2 message=FALSE, warning=FALSE}
birth_weight = 
  read_csv("./birthweight.csv") %>% 
  drop_na() %>%
  # recoding
   mutate(
     mrace = case_when(
      mrace == 1 ~ "White",
      mrace == 2 ~ "Black",
      mrace == 3 ~ "Asian",
      mrace == 4 ~ "Puerto Rican",
      mrace == 8 ~ "Other"),
     # converting to factors
     mrace = as.factor(mrace),
    frace = as.factor(frace),
    malform = as.factor(malform),
    babysex = case_when(
      babysex == 1 ~ "Male",
      babysex == 2 ~ "Female"), 
   babysex = as.factor(babysex))
```


The regression models accounts for the known factors that influence birth weight: gestational age, baby gender, smoking, mother's age and malformations that can affect weight and mother's obesity, all of which have been already reported to have an association with low birth weight. We converted number of cigarettes and pre-pregnancy weight into binary variables. 
We hypothesized that mother's race is a predictor of low birth weight independent (conditioned on) of the factors above.

```{r model message=FALSE, warning=FALSE}
lm_data <-
  birth_weight %>%
   mutate(
     obesity = case_when(
      ppbmi >40 ~ 1,
      ppbmi <=40 ~ 0),
      obesity = as.factor(obesity),
    smoking = case_when(
      smoken >0 ~ 1,
      smoken == 0 ~ 0),
     smoking = as.factor(smoking)) %>%
   select (mrace,  obesity, smoking, momage, babysex, bwt, gaweeks, malform, bhead, blength )  


first_model = lm(bwt ~ mrace + obesity + smoking + momage + babysex + gaweeks + malform, data = lm_data)

# plotting
lm_data %>% 
  modelr::add_residuals(first_model) %>% 
  modelr::add_predictions(first_model)  %>%
  ggplot(aes(x = mrace, y = resid)) + 
  geom_point() +
  labs(title = "Model residuals")
  
second_model = lm(bwt ~ blength + gaweeks, data = lm_data)
third_model = lm(bwt ~ bhead*blength*babysex , data = lm_data)

```
 We can see that residuals are different for Asians
```{r model_comp message=FALSE, warning=FALSE}

# create df for cross-validation
cross_val =
  crossv_mc(lm_data, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cross_val = 
  cross_val %>% 
  mutate(
    first_model  = map(train, lm(bwt ~ mrace + obesity + smoking + momage + babysex + gaweeks + malform, data = .x)),
    second_model =  map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    third_model  = map(train, ~lm(bwt ~ bhead*blength*babysex, data = .x))
    ) %>% 
  mutate(
    rmse_one = map2_dbl(first_model, test, ~rmse(model = .x, data = .y)),
    rmse_two    = map2_dbl(second_model, test, ~rmse(model = .x, data = .y)),
    rmse_three = map2_dbl(third_model, test, ~rmse(model = .x, data = .y)))

## Finally, Iâ€™ll plot the prediction error distribution for each candidate model.
cross_val %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()

```

